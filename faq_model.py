# -*- coding: utf-8 -*-
"""faq_model.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1ETn8nbChgij70MIV_mn9QJhGhqRruxgU
"""

import numpy as np
import os
import shutil

import tensorflow as tf
import tensorflow_hub as hub
import tensorflow_text as text
from official.nlp import optimization  # to create AdamW optimizer
from transformers import pipeline

import matplotlib.pyplot as plt

tf.get_logger().setLevel('ERROR')

pipe = pipeline("feature-extraction", model="DeepPavlov/rubert-base-cased")

questions = [
    "Какие учебные программы доступны на факультете бизнес-коммуникаций и информатики?",
    "Каким образом можно подать документы для поступления в ИГУ?",
    "Где можно найти актуальное расписание занятий?",
    "Какой адрес факультета бизнес-коммуникаций и информатики ИГУ?",
    "Какие контакты деканата ФБКИ ИГУ?",
    "На каких автобусных маршрутах можно доехать до факультета?",
    "Какие маршрутные такси следуют через факультет?",
    "Какие троллейбусы останавливаются возле ФБКИ ИГУ?",
    "Какие общежития предоставляются студентам факультета?",
    "Как зовут заведующую общежитием №3?",
    "Каким образом связаться с заведующей общежития №3?",
    "Как зовут заведующую общежитием №10?",
    "Каким образом связаться с заведующей общежития №10?",
    "Где находится общежитие №3?",
    "Где находится общежитие №10?",
    "Как можно связаться с приёмной комиссией факультета?",
    "Есть ли у факультета страницы в социальных сетях?",
    "Где можно найти новости и актуальную информацию о ФБКИ?",
    "Когда и как был создан факультет бизнес-коммуникаций и информатики?",
    "Почему ФБКИ иногда называют факультетом сервиса и рекламы?",
    "Кто занимает должность декана ФБКИ?",
    "Кто является заместителем декана по учебной работе?",
    "Имеются ли магистерские программы на ФБКИ?",
    "Каков срок обучения на направлении прикладная информатика?",
    "Какие студенческие организации есть в ИГУ?",
    "Какие виды стипендий предусмотрены для студентов ИГУ?",
    "Какую социальную поддержку оказывает ИГУ студентам?",
    "Проводятся ли в ИГУ подготовительные курсы?",
    "Кто преподает на подготовительных курсах ИГУ?",
    "Что включает программа подготовки на курсах ЕГЭ и ОГЭ?",
    "Как записаться на подготовительные курсы для школьников?",
    "Что собой представляет Иркутский государственный университет?",
    "Есть ли в ИГУ культурные и творческие объединения?",
    "Какие спортивные активности доступны в ИГУ?",
    "Кто занимает руководящие должности в ректорате ИГУ?",
    "Как устроена структура управления в ИГУ?",
    "Какие способы оплаты доступны для услуг университета?",
    "Как можно записаться на спортивные секции в ИГУ?",
    "Где узнать результаты экзаменов?",
    "Как запросить справку об обучении в университете?",
    "Когда начинаются студенческие каникулы?",
    "Что нужно для доступа к библиотеке ИГУ?",
    "Какие места питания доступны рядом с факультетом?",
    "Какие мероприятия организуются на факультете?",
    "Можно ли сменить специальность в процессе обучения?",
    "Как организована практика для студентов факультета?",
    "Каким образом восстановить студенческий билет?",
    "Какие льготы доступны для студентов ИГУ?",
    "Где найти информацию о дипломной работе?",
    "Какие иностранные языки можно изучать на факультете?",
    "Как получить консультацию преподавателя?",
    "Где найти учебные планы для специальностей?",
    "Можно ли продлить сроки сдачи курсовой работы?",
    "Куда обращаться по вопросам трудоустройства студентов?",
    "Как оформить академический отпуск?",
    "Какие курсы повышения квалификации доступны в университете?"
]

answers = [
    "На ФБКИ доступны такие направления, как реклама и связи с общественностью, туризм, управление персоналом, прикладная информатика и другие.",
    "Документы можно подать через сайт университета или обратиться лично в приёмную комиссию.",
    "Расписание занятий публикуется на сайте факультета в соответствующем разделе.",
    "Адрес факультета: г. Иркутск, ул. Лермонтова, 126, корпус 7.",
    "Контакты деканата: телефон (3952) 42-64-16, e-mail: dekanat@fbki.isu.ru.",
    "Доехать до факультета можно на автобусах: 3, 7к, 18, 40, 55, 57, 74, 80, 90, 442, 455, 456, 480.",
    "Через факультет проходят маршрутные такси: 10т, 45, 83, 334.",
    "Троллейбусы, идущие к факультету: 1, 6, 7, 10, 10к.",
    "Студенты ФБКИ проживают в общежитиях №3 и №10.",
    "Заведующая общежития №3 — Велисевич Ольга Алексеевна.",
    "Связаться с заведующей общежития №3 можно по телефону 52-11-78.",
    "Заведующая общежития №10 — Комарова Анна Александровна.",
    "Телефон заведующей общежития №10 — 52-10-12.",
    "Общежитие №3 находится по адресу: г. Иркутск, ул. Улан-Баторская, 6а.",
    "Общежитие №10 находится по адресу: г. Иркутск, ул. Улан-Баторская, 12.",
    "Приёмная комиссия факультета доступна по телефонам +7(3952) 521-555, 521-777, e-mail: priem@isu.ru, zpk@isu.ru.",
    "Да, у факультета есть страницы в социальных сетях, таких как ВКонтакте и Telegram.",
    "Актуальные новости факультета публикуются на сайте ФБКИ и в его социальных сетях.",
    "Факультет был основан 27 марта 1997 года решением Ученого совета ИГУ.",
    "Название факультета было изменено с факультета сервиса и рекламы на ФБКИ в 2020 году.",
    "Деканом ФБКИ является Синчурина Марина Георгиевна.",
    "Заместитель декана по учебной работе — Курмазова Юлия Евгеньевна.",
    "На ФБКИ есть магистерские программы. Подробности можно найти на сайте факультета.",
    "Срок обучения на прикладной информатике составляет 4 года.",
    "В ИГУ работают студенческие объединения, профсоюзы, отряды и предприятия.",
    "ИГУ предоставляет академическую, социальную и другие виды стипендий.",
    "Университет оказывает социальную помощь, медицинское обслуживание и компенсации студентам.",
    "Да, ИГУ проводит курсы подготовки к ЕГЭ и ОГЭ.",
    "Курсы ведут преподаватели ИГУ с опытом работы со школьниками.",
    "Программа курсов включает разбор сложных заданий ЕГЭ и углублённое изучение школьных предметов.",
    "Для записи на курсы заполните форму заявки на сайте ИГУ.",
    "ИГУ — это классический университет с вековыми традициями образования.",
    "В ИГУ работают творческие студии и культурные центры.",
    "Доступны спортивные секции, клубы, а также киберспортивные команды.",
    "Ректором ИГУ является Шмидт Александр Федорович. Подробности на сайте.",
    "Университет включает факультеты, научные институты, кафедры и другие структуры.",
    "Оплата возможна через реквизиты Сбербанка или 'Систему город'.",
    "Записаться на секции можно через спортивный комплекс или портал университета.",
    "Результаты экзаменов уточняйте у старосты или в деканате.",
    "Справку об обучении можно получить, подав заявление в деканат.",
    "Каникулы начинаются после экзаменов, обычно в январе и июле.",
    "Для доступа в библиотеку нужно оформить читательский билет.",
    "Рядом с факультетом есть студенческая столовая и кафе.",
    "Факультет организует конференции, спортивные и культурные мероприятия.",
    "Смена специальности возможна после согласования с деканатом.",
    "Практика организуется кафедрой и зависит от специальности.",
    "Для восстановления студенческого билета обратитесь в деканат.",
    "Студенты получают льготы на проезд, жильё и спорт.",
    "Информация о дипломных работах размещена на сайте факультета.",
    "На факультете можно изучать английский и китайский языки.",
    "Для консультации уточните расписание преподавателя на кафедре.",
    "Учебные планы доступны в разделе 'Образовательные программы' на сайте.",
    "Продление сдачи курсовой работы возможно по согласованию с руководителем.",
    "Центр карьеры университета помогает с трудоустройством.",
    "Для академического отпуска обратитесь в деканат с заявлением.",
    "Информация о курсах повышения квалификации есть на сайте."
]

dataset=[]
for i in range(len(questions)):
  q_emb = np.mean(pipe(questions[i])[0], axis=0)
  a_emb = np.mean(pipe(answers[i])[0], axis=0)
  dataset.append((q_emb, a_emb))
dataset=np.array(dataset)
print(dataset.shape)
X, Y = [], []
for i in range(dataset.shape[0]):
  for j in range(dataset.shape[0]):
    X.append(np.concatenate([dataset[i][0], dataset[j][1]]))
    if i == j:
      Y.append(1)
    else:
      Y.append(0)
X = np.array(X)
Y = np.array(Y)
X.shape, Y.shape, Y

model = tf.keras.models.Sequential()
model.add(tf.keras.layers.InputLayer(input_shape=(X.shape[1],)))
model.add(tf.keras.layers.Dense(100, activation='selu'))
model.add(tf.keras.layers.Dense(1, activation='sigmoid'))
es = tf.keras.callbacks.EarlyStopping(monitor='auc', mode='max', patience=10, restore_best_weights = True)
model.compile(optimizer = tf.keras.optimizers.Adam(learning_rate=1e-3), loss='binary_crossentropy',
              metrics=[tf.keras.metrics.AUC(curve='pr', name='auc')])
model.fit(X, Y, epochs=150, class_weight={0:1, 1:np.sqrt(Y.shape[0]) - 1}, validation_split=0.1)
model.summary()

input_quest = 'сколько лет длится обучение на прикладной информатике?'
embedding = np.mean(pipe(input_quest)[0], axis=0)
scores = []
for answer in answers:
    a_emb = np.mean(pipe(answer)[0], axis=0)
    input_vector = np.concatenate([embedding, a_emb])
    score = model.predict(np.expand_dims(input_vector, axis=0))[0][0]
    scores.append(score)
best_match = np.argmax(scores)
print(answers[best_match])

model.save('./model.keras')